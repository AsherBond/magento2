<?xml version="1.0" encoding="UTF-8"?>
<!--
 /**
   * Copyright 2024 Adobe
  * All Rights Reserved.
  */
-->

<tests xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
       xsi:noNamespaceSchemaLocation="urn:magento:mftf:Test/etc/testSchema.xsd">
    <test name="StorefrontVerifyRecentlyViewedWidgetTaxPricesTest">
        <annotations>
            <features value="Tax"/>
            <stories value="Recently Viewed Widget Tax Price Display"/>
            <title value="Verify price including and excluding tax in Recently Viewed Widget"/>
            <description value="Verify that Recently Viewed Widget displays correct prices including and excluding tax based on tax configuration"/>
            <severity value="AVERAGE"/>
            <testCaseId value="AC-8327"/>
            <group value="Tax"/>
        </annotations>
        <before>
            <!-- Pre-Condition 1:- Create Bundle Product -->
            <createData entity="_defaultCategory" stepKey="category"/>
            <createData entity="SpriteYogaStrap6Foot" stepKey="createYogaStrap6Foot">
                <requiredEntity createDataKey="category"/>
            </createData>
            <createData entity="SpriteYogaStrap8Foot" stepKey="createYogaStrap8Foot">
                <requiredEntity createDataKey="category"/>
            </createData>
            <createData entity="SpriteYogaStrap10Foot" stepKey="createYogaStrap10Foot">
                <requiredEntity createDataKey="category"/>
            </createData>
            <createData entity="SpriteYogaStrapsBundle" stepKey="createSpriteYogaStrapsBundle">
                <requiredEntity createDataKey="category"/>
            </createData>
            <createData entity="MultipleSelectOption" stepKey="createBundleOption1">
                <requiredEntity createDataKey="createSpriteYogaStrapsBundle"/>
                <field key="title">Choose Your Yoga Straps</field>
                <field key="required">true</field>
                <field key="type">multi</field>
            </createData>
            <createData entity="ApiBundleLink" stepKey="linkYogaStrap6Foot">
                <requiredEntity createDataKey="createSpriteYogaStrapsBundle"/>
                <requiredEntity createDataKey="createBundleOption1"/>
                <requiredEntity createDataKey="createYogaStrap6Foot"/>
                <field key="qty">1</field>
                <field key="is_default">true</field>
                <field key="price_type">0</field>
            </createData>
            <createData entity="ApiBundleLink" stepKey="linkYogaStrap8Foot">
                <requiredEntity createDataKey="createSpriteYogaStrapsBundle"/>
                <requiredEntity createDataKey="createBundleOption1"/>
                <requiredEntity createDataKey="createYogaStrap8Foot"/>
                <field key="qty">1</field>
                <field key="is_default">false</field>
                <field key="price_type">0</field>
            </createData>
            <createData entity="ApiBundleLink" stepKey="linkYogaStrap10Foot">
                <requiredEntity createDataKey="createSpriteYogaStrapsBundle"/>
                <requiredEntity createDataKey="createBundleOption1"/>
                <requiredEntity createDataKey="createYogaStrap10Foot"/>
                <field key="qty">1</field>
                <field key="is_default">false</field>
                <field key="price_type">0</field>
            </createData>
            <!-- Pre-Condition 2:- Taxable Goods has Tax Class configured (20%) -->
            <createData entity="US_All_Rate_20" stepKey="createUSAllTaxRate20"/>
            <!-- Step 1:- Login as admin -->
            <actionGroup ref="AdminLoginActionGroup" stepKey="loginAsAdmin"/>
            <actionGroup ref="AdminCreateTaxRuleActionGroup" stepKey="createDefaultTaxRule">
                <argument name="taxRate" value="$$createUSAllTaxRate20$$"/>
                <argument name="taxRule" value="defaultTaxRule"/>
            </actionGroup>
            <!-- Pre-Condition 3:- Price Display is set to show both prices including and excluding from Stores >> Configuration >> Sales >> Tax >> Price Display Settings. -->
            <magentoCLI command="config:set {{CustomDisplayProductPricesInCatalog.path}} {{CustomDisplayProductPricesInCatalog.value}}" stepKey="setPriceDisplayToBothPrices"/>
        </before>
        <after>
            <magentoCLI command="config:set tax/display/type 1" stepKey="resetTaxDisplayToDefault"/>
            <deleteData createDataKey="createSpriteYogaStrapsBundle" stepKey="deleteBundleProduct"/>
            <deleteData createDataKey="createYogaStrap6Foot" stepKey="deleteYogaStrap6Foot"/>
            <deleteData createDataKey="createYogaStrap8Foot" stepKey="deleteYogaStrap8Foot"/>
            <deleteData createDataKey="createYogaStrap10Foot" stepKey="deleteYogaStrap10Foot"/>
            <actionGroup ref="AdminDeleteTaxRule" stepKey="deleteTaxRule">
                <argument name="taxRuleCode" value="{{defaultTaxRule.code}}"/>
            </actionGroup>
            <deleteData createDataKey="createUSAllTaxRate20" stepKey="deleteTaxRate"/>
            <deleteData createDataKey="category" stepKey="deleteCategory"/>
            <actionGroup ref="AdminEditCMSPageContentActionGroup" stepKey="clearRecentlyViewedWidgetsFromCMSContent">
                <argument name="content" value="{{CmsHomePageContent.content}}"/>
                <argument name="pageId" value="{{CmsHomePageContent.page_id}}"/>
            </actionGroup>
            <actionGroup ref="AdminLogoutActionGroup" stepKey="logoutFromAdmin"/>
        </after>
        <!-- Step 2:- Create "Recently Viewed Widget" and add it to the home page -->
        <actionGroup ref="AdminOpenCmsPageActionGroup" stepKey="navigateToEditHomePage">
            <argument name="page_id" value="{{CmsHomePageContent.page_id}}"/>
        </actionGroup>
        <actionGroup ref="AdminInsertRecentlyViewedWidgetActionGroup" stepKey="insertRecentlyViewedWidget">
            <argument name="attributeSelector1" value="show_attributes"/>
            <argument name="attributeSelector2" value="show_buttons"/>
            <argument name="productAttributeSection1" value="1"/>
            <argument name="productAttributeSection2" value="4"/>
            <argument name="buttonToShowSection2" value="3"/>
        </actionGroup>
        <!-- Step 3:- Create "Catalog Product List Widget" and add it to the home page (for comparison), limit the visible SKU to created bundle product sku -->
        <conditionalClick selector="{{CmsNewPagePageActionsSection.contentSectionName}}" dependentSelector="{{CmsNewPagePageActionsSection.showHideEditor}}" visible="false" stepKey="expandContentSectionIfNotVisible"/>
        <waitForPageLoad time="30" stepKey="waitForPageLoadContentSection"/>
        <conditionalClick selector="{{CmsNewPagePageActionsSection.showHideEditor}}" dependentSelector="{{CatalogWidgetSection.insertWidgetButton}}" visible="false" stepKey="clickNextShowHideEditorIfVisible"/>
        <actionGroup ref="AdminInsertWidgetToCmsPageContentActionGroup" stepKey="insertCatalogProductsListWidget">
            <argument name="widgetType" value="Catalog Products List"/>
        </actionGroup>
        <actionGroup ref="AdminFillCatalogProductsListWidgetSkuActionGroup" stepKey="addSkuCondition">
            <argument name="sku" value="$$createSpriteYogaStrapsBundle.sku$$"/>
        </actionGroup>
        <actionGroup ref="AdminClickInsertWidgetActionGroup" stepKey="insertWidget"/>
        <actionGroup ref="AdminSaveAndContinueEditCmsPageActionGroup" stepKey="saveHomePageAfterCatalogProductListWidgetCreation"/>
        <!-- Step 4:- Search for "Set of Sprite Yoga Straps" product (the sample grouped product) and add to the cart -->
        <actionGroup ref="CliIndexerReindexActionGroup" stepKey="reindex">
            <argument name="indices" value=""/>
        </actionGroup>
        <actionGroup ref="CliCacheCleanActionGroup" stepKey="flushCache">
            <argument name="tags" value="full_page"/>
        </actionGroup>
        <actionGroup ref="StorefrontOpenHomePageActionGroup" stepKey="goToHomepage"/>
        <waitForElementVisible selector="{{StorefrontWidgetsSection.widgetProductsGrid}}" stepKey="waitForProductListWidget"/>
        <click selector="{{StorefrontWidgetsSection.widgetProductsGrid}} .product-item-link[title*='Set of Sprite Yoga Straps']" stepKey="clickOnBundleProductFromWidget"/>
        <actionGroup ref="StorefrontAddBundleProductFromProductToCartActionGroup" stepKey="addBundleProductToCart">
            <argument name="productName" value="Set of Sprite Yoga Straps"/>
        </actionGroup>
        <!-- Step 4 Result:- Verify the price of the "Set of Sprite Yoga Straps" both including and excluding price should be displayed correctly.(including : 15.16 and excluding 14) -->
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.includingTaxPrice}}" stepKey="waitForIncludingTaxPrice"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.includingTaxPrice}}" userInput="$16.80" stepKey="seeIncludingTaxPrice"/>
        <waitForElementVisible selector="{{StorefrontProductInfoMainSection.excludingTaxPrice}}" stepKey="waitForExcludingTaxPrice"/>
        <waitForText selector="{{StorefrontProductInfoMainSection.excludingTaxPrice}}" userInput="$14.00" stepKey="seeExcludingTaxPrice"/>
    </test>
</tests>
